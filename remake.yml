packages:
  - plyr
  - dplyr
  - tidyr
  - rstan
  - ggplot2
  - grid
  - gridExtra
  - lubridate
  - reshape2

sources:
  - 'R/data_processing.R'
  - 'R/models.R'
  - 'R/model_output_processing.R'
  - 'R/figures.R'

plot_options:
  A4_landscape:
    width: 11.69
    height: 8.27
  
  A4_portrait:
    width: 8.27
    height: 11.69
    
    
targets:
  all:
    depends:
      - export_processed_data
      - export_model_fits
      - figures
      
  export_processed_data:
    depends:
      - processed_data/complete_field_survey_data.rds
      - processed_data/complete_otc_seedling_data.rds
      - processed_data/hourly_microclimate_data.rds
      - processed_data/daily_microclimate_data.rds
      - processed_data/overall_microclimate_summary.rds
  
  export_model_fits:
    depends:
      - models/poadist_censored_model.rds
      - models/gap_dynamic_model.rds
      - models/non_tussock_otc_growth_model.rds
      - models/tussock_otc_growth_model.rds
      - models/non_tussock_otc_mortality_model.rds
      - models/tussock_otc_mortality_model.rds
      - models/greaus_seedling_density_model.rds
      - models/asttry_seedling_density_model.rds
      - models/greaus_seedling_max_ht_model.rds
      - models/asttry_seedling_max_ht_model.rds
      
  figures:
    depends:
      - figures/greaus_seedling_density.pdf
      - figures/seedling_obs_pred_height.pdf
      - figures/mortality.pdf
      - figures/seedling_max_height.pdf
      - figures/tussock_seedling_ht_mortality.pdf
      - figures/asttry_seedling_density.pdf
      - figures/intertussock_gap_dynamics.pdf
      - figures/mean_microclimate.pdf
      - figures/mean_min_microclimate.pdf
      - figures/mean_max_microclimate.pdf
      - figures/obs_dbh_growth.pdf
  #------------- Clean data --------------------------- 
  
  cleaned_poa_distances:
    command: clean_raw_censored_poa('raw_data/raw_poa_distances.csv')
    cleanup_level: purge
    check: exists
    
  median_poa_distances:
    command: calculate_median_poa_distances(cleaned_poa_distances, poadist_censored_model)
    cleanup_level: purge
    
  cleaned_otc_seedling_data:
    command: clean_seedling_data('raw_data/seedling_growth.csv')
    cleanup_level: purge

  complete_otc_seedling_data:
    command: merge_seedling_poa(cleaned_otc_seedling_data, median_poa_distances)
    cleanup_level: purge
    
  non_tussock_otc_growth_data:
    command: get_growth_data(complete_otc_seedling_data, FALSE)
    cleanup_level: purge
    
  tussock_otc_growth_data:
    command: get_growth_data(complete_otc_seedling_data, TRUE)
    cleanup_level: purge
    
  non_tussock_otc_mortality_data:
    command: get_mortality_data(complete_otc_seedling_data, FALSE)
    cleanup_level: purge  
    
  tussock_otc_mortality_data:
    command: get_mortality_data(complete_otc_seedling_data, TRUE)
    cleanup_level: purge
    
  cleaned_unburnt_data:
    command: clean_unburnt_data('raw_data/shrub_density_heights_unburnt.csv')
    cleanup_level: purge
    
  summarised_unburnt_data:
    command: summarise_unburnt_data(cleaned_unburnt_data)
    cleanup_level: purge
    
  cleaned_burnt_density_data:
    command: clean_burnt_density('raw_data/shrub_density_burnt.csv')
    cleanup_level: purge
    
  summarised_burnt_height_data:
    command: clean_burnt_ht('raw_data/seedling_heights_burnt.csv')
    cleanup_level: purge
    
  site_vars:
    command: read.csv('raw_data/site_variables.csv')
    cleanup_level: purge
    
  complete_field_survey_data:
    command: merge_all_quadrat_data(summarised_unburnt_data,
                                    cleaned_burnt_density_data,
                                    summarised_burnt_height_data,
                                    site_vars)
    cleanup_level: purge
    
  hourly_microclimate_data:
    command: process_hourly_microclimate('raw_data/otc_microstation_data.rds','raw_data/microstation_metadata.csv',I('ITEX2.0'),FALSE)
    cleanup_level: purge
  
  daily_microclimate_data:
    command: aggregate_microclimate_to_day(hourly_microclimate_data)
    cleanup_level: purge
    
  overall_microclimate_summary:
    command: calculate_overall_treatment_effects(hourly_microclimate_data, TRUE)
    cleanup_level: purge
    
  #------------- Run stan models ---------------------------

  non_tussock_otc_growth_model:
    command: run_non_tussock_growth_analysis(non_tussock_otc_growth_data, 70)
    cleanup_level: purge
    
  tussock_otc_growth_model:
    command: run_tussock_growth_analysis(tussock_otc_growth_data)
    cleanup_level: purge

  non_tussock_otc_mortality_model:
    command: run_non_tussock_mortalilty_model(non_tussock_otc_mortality_data)
    cleanup_level: purge
    
  tussock_otc_mortality_model:
    command: run_tussock_mortality_model(tussock_otc_mortality_data)
    cleanup_level: purge
    
  greaus_seedling_density_model:
    command: run_density_model(complete_field_survey_data, I("Grevillea"))
    cleanup_level: purge
    
  asttry_seedling_density_model:
    command: run_density_model(complete_field_survey_data, I("Asterolasia"))
    cleanup_level: purge  
    
  greaus_seedling_max_ht_model:
    command: run_max_height_model(complete_field_survey_data, I("Grevillea"))
    cleanup_level: purge
    
  asttry_seedling_max_ht_model:
    command: run_max_height_model(complete_field_survey_data, I("Asterolasia"))
    cleanup_level: purge

  gap_dynamic_model:
    command: run_gap_dynamic_model(median_poa_distances, 10)
    cleanup_level: purge
    
  poadist_censored_model:
    command: run_censored_model(cleaned_poa_distances)
    cleanup_level: purge
    check: exists

    
  #------------ Export processed data ---------------------------

  processed_data/complete_otc_seedling_data.rds:
    command: saveRDS(complete_otc_seedling_data, target_name)
    cleanup_level: purge
    
  processed_data/complete_field_survey_data.rds:
    command: saveRDS(complete_field_survey_data, target_name)
    cleanup_level: purge
    
  processed_data/hourly_microclimate_data.rds:
    command: saveRDS(hourly_microclimate_data, target_name)
    cleanup_level: purge
    
  processed_data/daily_microclimate_data.rds:
    command: saveRDS(daily_microclimate_data, target_name)
    cleanup_level: purge
    
  processed_data/overall_microclimate_summary.rds:
    command: saveRDS(overall_microclimate_summary, target_name)
    cleanup_level: purge
    
  #------------- Export stan models ---------------------------
  
  models/poadist_censored_model.rds:
    command: saveRDS(poadist_censored_model, target_name)
    cleanup_level: purge
    
  models/non_tussock_otc_growth_model.rds:
    command: saveRDS(non_tussock_otc_growth_model, target_name)
    cleanup_level: purge
    
  models/tussock_otc_growth_model.rds:
    command: saveRDS(tussock_otc_growth_model, target_name)
    cleanup_level: purge   

  models/non_tussock_otc_mortality_model.rds:
    command: saveRDS(non_tussock_otc_mortality_model, target_name)
    cleanup_level: purge
    
  models/tussock_otc_mortality_model.rds:
    command: saveRDS(tussock_otc_mortality_model, target_name)
    cleanup_level: purge

  models/gap_dynamic_model.rds:
    command: saveRDS(gap_dynamic_model, target_name)
    cleanup_level: purge
    
  models/greaus_seedling_density_model.rds:
    command: saveRDS(greaus_seedling_density_model, target_name)
    cleanup_level: purge
    
  models/asttry_seedling_density_model.rds:
    command: saveRDS(asttry_seedling_density_model, target_name)
    cleanup_level: purge
    
  models/greaus_seedling_max_ht_model.rds:
    command: saveRDS(greaus_seedling_max_ht_model, target_name)
    cleanup_level: purge

  models/asttry_seedling_max_ht_model.rds:
    command: saveRDS(asttry_seedling_max_ht_model, target_name)
    cleanup_level: purge
  
  #------------- make figures ---------------------------

  figures/greaus_seedling_density.pdf:
    command: density_count_plots(greaus_seedling_density_model, I('Grevillea'))
    plot: A4_landscape
    
  figures/seedling_obs_pred_height.pdf:
    command: obs_pred_ht_growth(non_tussock_otc_growth_data, non_tussock_otc_growth_model)
    plot: A4_landscape
    
  figures/mortality.pdf:
    command: non_tussock_mortality_plot(non_tussock_otc_mortality_model)
    plot: A4_landscape
    
  figures/seedling_max_height.pdf:
    command: max_ht_plots(greaus_seedling_max_ht_model, asttry_seedling_max_ht_model)
    plot: A4_portrait
    
  figures/tussock_seedling_ht_mortality.pdf:
    command: tussock_plots(tussock_otc_growth_model,tussock_otc_mortality_model)
    plot: A4_landscape
    
  figures/asttry_seedling_density.pdf:
    command: density_count_plots(asttry_seedling_density_model, I('Asterolasia'))
    plot: A4_landscape
    
  figures/intertussock_gap_dynamics.pdf:
    command: gap_dynamics_plot(gap_dynamic_model)
    plot: A4_landscape
  
  figures/mean_microclimate.pdf:
    command: microclimate_diff_plots(hourly_microclimate_data,I('ITEX2.0'),I('mean'), stat_label = I('Mean'))
    plot: A4_landscape
    
  figures/mean_min_microclimate.pdf:
    command: microclimate_diff_plots(hourly_microclimate_data,I('ITEX2.0'),I('mean_min'), stat_label = I('Mean minimum'))
    plot: A4_landscape
    
  figures/mean_max_microclimate.pdf:
    command: microclimate_diff_plots(hourly_microclimate_data,I('ITEX2.0'),I('mean_max'), stat_label = I('Mean maximum'))
    plot: A4_landscape
    
  figures/obs_dbh_growth.pdf:
    command: plot_obs_growth(non_tussock_otc_growth_data,I('stem_diam'), ylab =I('Observed stem diameter (mm)'), ylim=I(c(0,35)))
    plot: A4_landscape

# paper
#  downloads/style.csl:
#    command: get_amnat_csl(target_name)

#  ms.pdf:
#    command: pandoc_build("ms.md")

#  ms.md:
#    knitr: true
#    depends:
#      - data/refs.bib
#     - downloads/style.csl
